!function(n){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.Tiebreaker=n()}}(function(){return function n(t,r,e){function i(u,s){if(!r[u]){if(!t[u]){var a="function"==typeof require&&require;if(!s&&a)return a(u,!0);if(o)return o(u,!0);var f=new Error("Cannot find module '"+u+"'");throw f.code="MODULE_NOT_FOUND",f}var c=r[u]={exports:{}};t[u][0].call(c.exports,function(n){var r=t[u][1][n];return i(r?r:n)},c,c.exports,n,t,r,e)}return r[u].exports}for(var o="function"==typeof require&&require,u=0;u<e.length;u++)i(e[u]);return i}({1:[function(n,t,r){var e=Array.prototype.slice,i=function(){var n=arguments;return function(){for(var t=n[0].apply(this,arguments),r=1,e=n.length;e>r;r+=1)t=n[r](t);return t}},o=i;o.seq=i,o.id=function(n){return n},o.noop=function(){},o.copy=function(n){return Array.isArray(n)?n.slice():n===Object(n)?o.extend({},n):n},o.constant=function(n){return function(){return o.copy(n)}},o.not=function(n){return function(t){return!n(t)}},o.all=function(n){return function(t){return t.every(n)}},o.any=function(n){return function(t){return t.some(n)}},o.none=function(n){return function(t){return!t.some(n)}},o.elem=function(n){return function(t){return n.indexOf(t)>=0}},o.notElem=function(n){return function(t){return n.indexOf(t)<0}},o.extend=function(n,t){for(var r=Object.keys(t),e=0;e<r.length;e+=1){var i=r[e];n[i]=t[i]}return n},o.gcd=function(n,t){for(n=Math.abs(n),t=Math.abs(t);t;){var r=t;t=n%t,n=r}return n},o.lcm=function(n,t){return n&&t?Math.abs(n*t/o.gcd(n,t)):0},o.even=function(n){return n%2===0},o.odd=function(n){return n%2===1},o.get=function(){var n=arguments;return function(t){for(var r=t,e=0;e<n.length&&void 0!==r;e+=1)r=r[n[e]];return r}},o.pluck=function(n,t){for(var r=[],e=0,i=t.length;i>e;e+=1)r[e]=t[e][n];return r},o.first=function(n){return n[0]},o.last=function(n){return n[n.length-1]},o.firstBy=function(n,t){for(var r=0,e=t.length;e>r;r+=1)if(n(t[r]))return t[r]},o.lastBy=function(n,t){for(var r=t.length-1;r>=0;r-=1)if(n(t[r]))return t[r]},o.range=function(n,t,r){arguments.length<=1&&(t=n,n=1),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n+1)/r),0),i=new Array(e),o=0;e>o;o+=1,n+=r)i[o]=n;return i},o.replicate=function(n,t){for(var r=[],e=0;n>e;e+=1)r.push(o.copy(t));return r},o.zipWith=function(){for(var n=arguments[0],t=e.call(arguments,1),r=t.length,i=[],u=Math.min.apply(Math,o.pluck("length",t)),s=0;u>s;s+=1){for(var a=[],f=0;r>f;f+=1)a.push(t[f][s]);i.push(n.apply(this,a))}return i},o.zip=function(){for(var n=arguments.length,t=[],r=Math.min.apply(Math,o.pluck("length",arguments)),e=0;r>e;e+=1){for(var i=[],u=0;n>u;u+=1)i.push(arguments[u][e]);t.push(i)}return t},o.iterate=function(n,t,r){for(var e=[t],i=1;n>i;i+=1)e.push(r(e[i-1]));return e},o.scan=function(n,t,r){for(var e=[t],i=0,o=n.length;o>i;i+=1)e.push(r(e[i],n[i]));return e},o.reduce=function(n,t){return function(r){return r.reduce(n,t)}},o.map=function(n){return function(t){return t.map(n)}},o.filter=function(n){return function(t){return t.filter(n)}},o.invoke=function(n){var t=e.call(arguments,1);return function(r){var e=r[n];return e.apply(r,t)}},t.exports=o},{}],2:[function(n,t,r){var e=function(n,t){var r=Math.ceil(n/t);t=e.minimalGroupSize(n,t,r);for(var i=r*t,o=[],u=0;r>u;u+=1)o[u]=[];for(var s=0;s<Math.ceil(t/2);s+=1)for(var a=0;r>a;a+=1){var f=s*r+a+1;o[a].push(f),o[a].length<t&&o[a].push(i+1-f)}return o.map(function(t){return t.sort(function(n,t){return n-t}).filter(function(t){return n>=t})})};e.fromArray=function(n,t){return e(n.length,t).map(function(t){return t.map(function(t){return n[t-1]})})},e.minimalGroupSize=function(n,t){for(var r=arguments[2]||Math.ceil(n/t);r*t-n>=r;)t-=1;return t},t.exports=e},{}],3:[function(n,t,r){function e(n,t,r){return this instanceof e?(this.s=n,this.r=t,void(this.m=r)):new e(n,t,r)}var i=n("interlude"),o=n("tournament"),u=n("roundrobin"),s=n("group");e.prototype.toString=function(){return"G"+this.s+" R"+this.r+" M"+this.m};var a=function(n){return 2*n-1},f=function(n){return 2*n},c=function(n,t,r){for(var i=s(n,t),c=[],l=0;l<i.length;l+=1)for(var p=i[l],h=u(p.length,p),d=0;d<h.length;d+=1)for(var m=h[d],g=0;g<m.length;g+=1){var v=m[g];if(r){var y=v.slice().reverse();c.push({id:new e(l+1,a(d+1),g+1),p:v}),c.push({id:new e(l+1,f(d+1),g+1),p:y})}else c.push({id:new e(l+1,d+1,g+1),p:v})}return c.sort(o.compareMatches)},l=o.sub("GroupStage",function(n,t){var r=c(this.numPlayers,n.groupSize,n.meetTwice);this.numGroups=i.maximum(r.map(i.get("id","s"))),this.groupSize=Math.ceil(this.numPlayers/this.numGroups),this.winPoints=n.winPoints,this.tiePoints=n.tiePoints,this.scoresBreak=n.scoresBreak,t(r)});l.configure({defaults:function(n,t){return t.groupSize=Number(t.groupSize)||n,t.meetTwice=Boolean(t.meetTwice),t.winPoints=Number.isFinite(t.winPoints)?t.winPoints:3,t.tiePoints=Number.isFinite(t.tiePoints)?t.tiePoints:1,t.scoresBreak=Boolean(t.scoresBreak),t},invalid:function(n,t){return 2>n?"numPlayers cannot be less than 2":t.groupSize<2?"groupSize cannot be less than 2":t.groupSize>n?"groupSize cannot be greater than numPlayers":null}}),l.prototype.groupFor=function(n){for(var t=0;t<this.matches.length;t+=1){var r=this.matches[t];if(r.p.indexOf(n)>=0)return r.id.s}},l.prototype._safe=i.constant(!0),l.prototype._initResult=function(n){return{grp:this.groupFor(n),gpos:this.groupSize,pts:0,draws:0,losses:0}},l.prototype._stats=function(n,t){if(!t.m)return n;var r=o.resultEntry(n,t.p[0]),e=o.resultEntry(n,t.p[1]);if(t.m[0]===t.m[1])r.pts+=this.tiePoints,e.pts+=this.tiePoints,r.draws+=1,e.draws+=1;else{var i=t.m[0]>t.m[1]?r:e,u=t.m[0]>t.m[1]?e:r;i.wins+=1,i.pts+=this.winPoints,u.losses+=1}return r["for"]+=t.m[0],e["for"]+=t.m[1],r.against+=t.m[1],e.against+=t.m[0],n};var p=function(n,t){for(var r=i.replicate(t,[]),e=0;e<n.length;e+=1){var o=n[e];r[o.grp-1].push(o)}return r},h=function(n,t,r,e){o.resTieCompute(n,t,e,function(n){var t="PTS"+n.pts;return r&&(t+="DIFF"+(n["for"]-n.against)),t})},d=function(n,t){var r=n["for"]-n.against,e=t["for"]-t.against;return t.pts-n.pts||e-r||n.seed-t.seed},m=function(n,t){return n.pos-t.pos||d(n,t)};l.prototype._sort=function(n){var t=this.scoresBreak;n.sort(d);var r=i.replicate(this.groupSize,[]);if(p(n,this.numGroups).forEach(function(n){h(n,0,t,function(n,t){n.gpos=t,r[t-1].push(n)})}),this.isDone()){var e=1;r.forEach(function(n){n.forEach(function(n){n.pos=e}),e+=n.length})}return n.sort(m)},l.prototype.rawPositions=function(n){return p(n,this.numGroups).map(function(n){for(var t=i.replicate(n.length,[]),r=0;r<n.length;r+=1){var e=n[r];i.insert(t[e.gpos-1],e.seed)}return t})},l.id=e,l.Id=e,t.exports=l},{group:2,interlude:4,roundrobin:6,tournament:9}],4:[function(n,t,r){var e=n("autonomy");t.exports=function(){var n=arguments;return function(){for(var t=n[0].apply(this,arguments),r=1,e=n.length;e>r;r+=1)t=n[r](t);return t}},e.extend(t.exports,e),e.extend(t.exports,n("operators")),e.extend(t.exports,n("subset"))},{autonomy:1,operators:5,subset:7}],5:[function(n,t,r){var e={},i=Array.prototype.concat;e.plus2=function(n,t){return n+t},e.plus3=function(n,t,r){return n+t+r},e.plus4=function(n,t,r,e){return n+t+r+e},e.times2=function(n,t){return n*t},e.times3=function(n,t,r){return n*t*r},e.times4=function(n,t,r,e){return n*t*r*e},e.and2=function(n,t){return n&&t},e.and3=function(n,t,r){return n&&t&&r},e.and4=function(n,t,r,e){return n&&t&&r&&e},e.or2=function(n,t){return n||t},e.or3=function(n,t,r){return n||t||r},e.or4=function(n,t,r,e){return n||t||r||e},e.append2=function(n,t){return n.concat(t)},e.append3=function(n,t,r){return n.concat(t,r)},e.append4=function(n,t,r,e){return n.concat(t,r,e)},e.prepend2=function(n,t){return t.concat(n)},e.sum=function(n){for(var t=0,r=0;r<n.length;r+=1)t+=n[r];return t},e.product=function(n){for(var t=1,r=0,e=n.length;e>r;r+=1)t*=n[r];return t},e.and=function(n){for(var t=!0,r=0,e=n.length;e>r;r+=1)t=t&&n[r];return t},e.or=function(n){for(var t=!1,r=0,e=n.length;e>r;r+=1)t=t||n[r];return t},e.flatten=function(n){return i.apply([],n)},e.add=function(){for(var n=0,t=0,r=arguments.length;r>t;t+=1)n+=arguments[t];return n},e.multiply=function(){for(var n=1,t=0,r=arguments.length;r>t;t+=1)n*=arguments[t];return n},e.concat=function(){return i.apply([],arguments)},e.minus2=function(n,t){return n-t},e.divide2=function(n,t){return n/t},e.div2=function(n,t){return Math.floor(n/t)},e.mod2=function(n,t){return n%t},e.pow2=Math.pow,e.log2=function(n,t){return Math.log(n)/Math.log(t)},e.eq2=function(n,t){return n===t},e.neq2=function(n,t){return n!==t},e.gt2=function(n,t){return n>t},e.lt2=function(n,t){return t>n},e.gte2=function(n,t){return n>=t},e.lte2=function(n,t){return t>=n},e.plus=function(n){return function(t){return t+n}},e.minus=function(n){return function(t){return t-n}},e.times=function(n){return function(t){return t*n}},e.divide=function(n){return function(t){return t/n}},e.div=function(n){return function(t){return Math.floor(t/n)}},e.mod=function(n){return function(t){return t%n}},e.pow=function(n){return function(t){return Math.pow(t,n)}},e.log=function(n){return function(t){return Math.log(t)/Math.log(n)}},e.append=function(n){return function(t){return t.concat(n)}},e.prepend=function(n){return function(t){return n.concat(t)}},e.gt=function(n){return function(t){return t>n}},e.lt=function(n){return function(t){return n>t}},e.eq=function(n){return function(t){return t===n}},e.neq=function(n){return function(t){return t!==n}},e.gte=function(n){return function(t){return t>=n}},e.lte=function(n){return function(t){return n>=t}},t.exports=e},{}],6:[function(n,t,r){const e=-1;t.exports=function(n,t){var r=[];if(t)t=t.slice();else{t=[];for(var i=1;n>=i;i+=1)t.push(i)}n%2===1&&(t.push(e),n+=1);for(var o=0;n-1>o;o+=1){r[o]=[];for(var u=0;n/2>u;u+=1)t[u]!==e&&t[n-1-u]!==e&&r[o].push([t[u],t[n-1-u]]);t.splice(1,0,t.pop())}return r}},{}],7:[function(n,t,r){var e={};e.equality=function(){var n=arguments;return function(t,r){for(var e=0,i=n.length;i>e;e+=1)if(t[n[e]]!==r[n[e]])return!1;return!0}},e.compare=function(n,t){return"function"==typeof n?(t=t||1,function(r,e){return t*(n(r)-n(e))}):(n=n||1,function(t,r){return n*(t-r)})},e.comparing=function(){var n=arguments;return function(t,r){for(var e=0,i=n.length;i>e;e+=2){var o=n[e+1]||1;if(t[n[e]]!==r[n[e]])return o*(t[n[e]]-r[n[e]])}return 0}};var i=function(n,t){return n===t};e.maximum=function(n){return Math.max.apply(Math,n)},e.minimum=function(n){return Math.min.apply(Math,n)},e.maximumBy=function(n,t){for(var r=1,e=t[0],i=t.length;i>r;r+=1)n(t[r],e)>0&&(e=t[r]);return e},e.minimumBy=function(n,t){for(var r=1,e=t[0],i=t.length;i>r;r+=1)n(t[r],e)<0&&(e=t[r]);return e},e.insertBy=function(n,t,r){for(var e=0,i=t.length;i>e;e+=1)if(n(t[e],r)>=0)return t.splice(e,0,r),t;return t.push(r),t},e.insert=function(n,t){return e.insertBy(e.compare(),n,t)},e.deleteBy=function(n,t,r){for(var e=0,i=t.length;i>e;e+=1)if(n(t[e],r))return t.splice(e,1),t;return t},e["delete"]=function(n,t){var r=n.indexOf(t);return r>=0&&n.splice(r,1),n},e.intersectBy=function(n,t,r){var e=[],i=t.length,o=r.length;if(i&&o)for(var u=0;i>u;u+=1)for(var s=t[u],a=0;o>a;a+=1)if(n(s,r[a])){e.push(s);break}return e},e.intersect=function(n,t){return e.intersectBy(i,n,t)},e.nubBy=function(n,t){for(var r=[],e=0,i=t.length;i>e;e+=1){for(var o=!0,u=0,s=r.length;s>u;u+=1)if(n(r[u],t[e])){o=!1;break}o&&r.push(t[e])}return r},e.nub=function(n){for(var t=[],r=0,e=n.length;e>r;r+=1)t.indexOf(n[r])<0&&t.push(n[r]);return t},e.groupBy=function(n,t){for(var r,e,i=[],o=0,u=t.length;u>o;o=r){for(e=[t[o]],r=o+1;u>r&&n(t[o],t[r]);r+=1)e.push(t[r]);i.push(e)}return i},e.group=function(n){return e.groupBy(i,n)},e.unionBy=function(n,t,r){return t.concat(t.reduce(e.deleteBy.bind(null,n),e.nubBy(n,r)))},e.union=function(n,t){return n.concat(n.reduce(e["delete"],e.nub(t)))},e.differenceBy=function(n,t,r){return r.reduce(e.deleteBy.bind(null,n),t.slice())},e.difference=function(n,t){return t.reduce(e["delete"],n.slice())},e.isSubsetOf=function(n,t,r){for(var e=t.slice(),i=0;i<n.length;i+=1){var o=n[i],u=e.indexOf(o);if(0>u)return!1;e.splice(u,1)}return r?e.length>0:!0},t.exports=e},{}],8:[function(n,t,r){var e=n("interlude"),i={NONE:0};i.findMatch=function(n,t){return e.firstBy(function(n){return t.s===n.id.s&&t.r===n.id.r&&t.m===n.id.m},n)},i.findMatches=function(n,t){return n.filter(function(n){return!(null!=t.s&&n.id.s!==t.s||null!=t.r&&n.id.r!==t.r||null!=t.m&&n.id.m!==t.m)})},i.findMatchesRanged=function(n,t,r){return r=r||{},n.filter(function(n){return(null==t.s||n.id.s>=t.s)&&(null==t.r||n.id.r>=t.r)&&(null==t.m||n.id.m>=t.m)&&(null==r.s||n.id.s<=r.s)&&(null==r.r||n.id.r<=r.r)&&(null==r.m||n.id.m<=r.m)})},i.partitionMatches=function(n,t,r,e){for(var i=[],o=0;o<n.length;o+=1){var u=n[o];null!=e&&u.id[r]!==e||(Array.isArray(i[u.id[t]-1])||(i[u.id[t]-1]=[]),i[u.id[t]-1].push(u))}return i},i.matchesForPlayer=function(n,t){return n.filter(function(n){return n.p.indexOf(t)>=0})},i.players=function(n){var t=n.reduce(function(n,t){return n.concat(t.p)},[]);return e.nub(t).filter(e.gt(i.NONE)).sort(e.compare())},i.rounds=function(n){return e.nub(n.map(e.get("id","r"))).sort(e.compare())},i.upcoming=function(n,t){return n.filter(function(n){return n.p.indexOf(t)>=0&&!n.m})},i.started=function(n){return n.some(function(n){return n.p.every(e.gt(i.NONE))&&n.m})},i.playable=function(n){return!n.p.some(e.eq(i.NONE))},t.exports=i},{interlude:4}],9:[function(n,t,r){function e(n,t){this.matches=t,this.state=[]}var i=n("interlude"),o=n("./match");Object.defineProperty(e,"NONE",{enumerable:!0,value:o.NONE}),Object.defineProperty(e,"helpers",{value:o});var u=function(n,t){if(o.started(n.matches))throw new Error("Cannot replace players for a tournament in progress");n.matches.forEach(function(n){n.p=n.p.map(function(n){return n>0?t[n-1].seed:n})})};e.from=function(n,t,r,e){var i="Cannot forward from "+t.name+": ";if(!t.isDone())throw new Error(i+"tournament not done");var o=t.results();if(o.length<r)throw new Error(i+"not enough players");var s=o.filter(function(n){return n.pos<=r});if(s.length>r)throw new Error(i+"too many players tied to pick out top "+r);var a=new n(r,e);return u(a,o),a},e.resultEntry=function(n,t){for(var r=0;r<n.length;r+=1)if(n[r].seed===t)return n[r];throw new Error("No result found for seed "+t+" in result array:"+n)};var s=function(n){return n+""=="[object Object]"?"S"+n.s+" R"+n.r+" M"+n.m:n+""};e.isInteger=function(n){return Math.ceil(n)===n},e.sub=function(n,t,r){var i=r||e,o=function(r,e){if(!(this instanceof o))return new o(r,e);if(!o.invalid)throw new Error(n+" must implement an Invalid function");Object.defineProperty(this,"_opts",{configurable:!0,value:(o.defaults?o:i).defaults(r,e)});var u=o.invalid(r,this._opts);if(null!==u)throw this._opts.log.error("Invalid %d player %s with opts=%j rejected",r,n,this._opts),new Error("Cannot construct "+n+": "+u);this.numPlayers=r,this.name=n,t.call(this,this._opts,i.bind(this,r))};return i.inherit(o,i),o},e.invalid=i.constant(null),e.defaults=function(n,t){var r=i.extend({},t||{});return r.log=t&&t.log?t.log:console,r},e.configure=function(n,t,r){var i=r||e;t.defaults?n.defaults=function(n,r){return t.defaults(n,i.defaults(n,r))}:n.defaults=i.defaults,t.invalid?n.invalid=function(r,i){if(!e.isInteger(r))return"numPlayers must be a finite integer";var o=t.invalid(r,n.defaults(r,i));return null!==o?o:null}:n.invalid=i.invalid},e.inherit=function(n,t){var r=t||e;n.prototype=Object.create(r.prototype);var o={_verify:null,_progress:void 0,_early:!1,_safe:!1,_initResult:{}};Object.keys(o).forEach(function(t){n.prototype[t]=r.prototype[t]||i.constant(o[t])}),n.from=function(t,r,i){return e.from(n,t,r,i)},n.restore=function(t,r,e){var i=new n(t,r);return e.forEach(function(n){"score"===n.type&&i.score(n.id,n.score)}),i},n.configure=function(t){return e.configure(n,t,r)},n.sub=function(t,e){return r.sub(t,e,n)},n.inherit=function(t){return r.inherit(t,n)}},e.compareMatches=function(n,t){return n.id.s-t.id.s||n.id.r-t.id.r||n.id.m-t.id.m},e.compareRes=function(n,t){return n.pos-t.pos||n.seed-t.seed},e.compareZip=function(n,t){return t[1]-n[1]||n[0]-t[0]},e.sorted=function(n){return i.zip(n.p,n.m).sort(e.compareZip).map(i.get("0"))},e.resTieCompute=function(n,t,r,e){for(var i=t,o=0,u=-(1/0),s=0;s<n.length;s+=1){var a=n[s],f=e(a);f===u?o+=1:(i+=o+1,o=0),u=f,r(a,i)}},e.matchTieCompute=function(n,t,r){for(var e=t,i=0,o=-(1/0),u=0;u<n.length;u+=1){var s=n[u],a=s[0],f=s[1];o===f?i+=1:(e+=1+i,i=0),o=f,r(a,e)}},e.prototype.isDone=function(){return this.matches.every(i.get("m"))||this._early()},e.prototype.unscorable=function(n,t,r){var e=this.findMatch(n);return e?this.isPlayable(e)?Array.isArray(t)&&t.every(Number.isFinite)?t.length!==e.p.length?s(n)+" scores must have length "+e.p.length:r||!Array.isArray(e.m)||this._safe(e)?this._verify(e,t):s(n)+" cannot be re-scored":s(n)+" scores must be a numeric array":s(n)+" not ready - missing players":s(n)+" not found in tournament"},e.prototype.score=function(n,t){var r=this.unscorable(n,t,!0);if(null!==r)return this._opts.log.error("failed scoring match %s with %j",s(n),t),this._opts.log.error("reason:",r),!1;var e=this.findMatch(n);return e.m=t,this.state.push({type:"score",id:n,score:t}),this._progress(e),!0},e.prototype.results=function(){var n=this.players();if(this.numPlayers!==n.length){var t=n.length+" !== "+this.numPlayers;throw new Error(this.name+" initialized numPlayers incorrectly: "+t)}for(var r=new Array(this.numPlayers),o=0;o<this.numPlayers;o+=1)r[o]={seed:n[o],wins:0,"for":0,against:0,pos:this.numPlayers},i.extend(r[o],this._initResult(n[o]));return this._stats instanceof Function&&this.matches.reduce(this._stats.bind(this),r),this._sort instanceof Function?this._sort(r):r.sort(e.compareRes)},e.prototype.resultsFor=function(n){return i.firstBy(function(t){return t.seed===n},this.results())},e.prototype.upcoming=function(n){return o.upcoming(this.matches,n)},e.prototype.isPlayable=o.playable,e.prototype.findMatch=function(n){return o.findMatch(this.matches,n)},e.prototype.findMatches=function(n){return o.findMatches(this.matches,n)},e.prototype.findMatchesRanged=function(n,t){return o.findMatchesRanged(this.matches,n,t)},e.prototype.rounds=function(n){return o.partitionMatches(this.matches,"r","s",n)},e.prototype.sections=function(n){return o.partitionMatches(this.matches,"s","r",n)};var a=function(n){return n.some(function(n){return!n.m})};e.prototype.currentRound=function(n){return i.firstBy(a,this.rounds(n))},e.prototype.nextRound=function(n){for(var t=this.rounds(n),r=0;r<t.length;r+=1)if(a(t[r]))return t[r+1]},e.prototype.matchesFor=function(n){return o.matchesForPlayer(this.matches,n)},e.prototype.players=function(n){return o.players(this.findMatches(n||{}))},t.exports=e},{"./match":8,interlude:4}],tiebreaker:[function(n,t,r){function e(n,t,r,e){this.s=n,this.r=t,this.m=r,Object.defineProperty(this,"_simple",{value:e})}function i(n,t,r,u){if(!(this instanceof i))return new i(n,t,r,u);this._opts=i.defaults(u);var a=i.invalid(n,t,this._opts,r);if(null!==a)throw this._opts.log.error("Invalid %d player TieBreaker with oldRes=%j rejected, opts=%j",r,n,this._opts),new Error("Cannot construct TieBreaker: "+a);var f=p(t,r,this._opts),c=[];if(this._opts.grouped){for(var l=0;l<f.length;l+=1)for(var h=0;h<f[l].matches.length;h+=1){var d=f[l].matches[h];c.push({id:new e(f[l].tbSection,d.id.r,d.id.m),p:d.p.slice()})}this.groupStages=f}else c=f;s.call(this,n.length,c),this.name="TieBreaker",this.grouped=this._opts.grouped,this.strict=this._opts.strict,this.posAry=t,this.limit=r,this.oldRes=n,this.numSections=t.length,this.sectionSize=o.flatten(t[0]).length,this.betweenPosition=Math.ceil(this.limit/this.numSections);var m=this.players();this.numPlayers=m.length;var g=n.filter(function(n){return m.indexOf(n.seed)<0&&n.pos<=r}).length;n.forEach(function(n){m.indexOf(n.seed)>=0&&(n.pos=m.length+g)})}var o=n("interlude"),u=n("groupstage"),s=n("tournament");e.prototype.toString=function(){return this._simple?"S"+this.s+" TB":"S"+this.s+" TB R"+this.r+" M"+this.m};var a=function(n){return new e(n,1,1,!0)},f=function(n,t,r){var e=n.length,i=Math.ceil(t/e);return n.map(function(n){for(var t=i,e=0;t>0;e+=1){var o=n[e],u=o.length>1&&o.length===t&&r;if(o.length>t||u)return o.slice();t-=o.length}return[]})},c=function(n,t,r){var e=new u(n.length,r);return e.tbSection=t,e.matches.forEach(function(t){t.p.forEach(function(r,e){t.p[e]=n[r-1]})}),e},l=function(n,t){return{id:a(t),p:n}},p=function(n,t,r){var e=[];return f(n,t,r.breakForBetween).forEach(function(n,t){if(n.length){var i=r.grouped?c:l;e.push(i(n,t+1,r.groupOpts))}}),e},h=function(n){if(!this.grouped){var t=this.findMatch({s:n,r:1,m:1});return t&&t.m?t:null}var r=o.firstBy(function(t){return t.tbSection===n},this.groupStages);if(null==r||!r.isDone())return null;var e=r.results(),i=r.rawPositions(e),u={p:[],m:[]};return i[0].forEach(function(n,t){n.forEach(function(n){u.p.push(n),u.m.push(i[0].length-t)})}),u},d=function(n,t){var r=o.replicate(n.length,[]);return n.forEach(function(n,e){if(n.indexOf(t.p[0])<0)return void(r[e]=r[e].concat(n));var i=o.zip(t.p,t.m).sort(s.compareZip);s.matchTieCompute(i,0,function(n,t){r[e+t-1].push(n)})}),r};s.inherit(i),i.invalid=function(n,t,r,e){if(!Array.isArray(n))return"results must be implemented";if(!Array.isArray(t)||!t.length)return"rawPositions must be implemented properly";if(!s.isInteger(e)||1>e||e>=n.length)return"limit must be an integer in {1, ..., previous.numPlayers}";if(e%t.length!==0)return"number of sections must divide limit";n.forEach(function(n){return[n.seed,n["for"],n.pos].every(s.isInteger)?void 0:"invalid results format - common properties missing"});var i=t[0].length,u=o.flatten(t[0]).length;return t.forEach(function(n){return n.forEach(function(n){return!s.isInteger(n)||n<=s.NONE?"invalid rawPositions - all entries must be arrays of integers":void 0}),Math.abs(n.length-i)>1?"rawPositions must be ~equally long for every section":Math.abs(o.flatten(n).length-u)>1?"rawPositions must contain ~equally many players per section":void 0}),null},i.defaults=function(n){var t=s.defaults(Math.Infinity,n||{});return t.breakForBetween=Boolean(t.breakForBetween),t.grouped=Boolean(t.grouped),t.groupOpts=t.grouped?u.defaults(Math.Infinity,t.groupOpts):{},delete t.groupOpts.groupSize,delete t.groupOpts.log,t.strict=Boolean(t.strict)&&!t.grouped,t},i.from=function(n,t,r){var e="Cannot forward from "+n.name+": ";if(!n.isDone())throw new Error(e+"tournament not done");var o=n.results();if(o.length<t)throw new Error(e+"not enough players");if(!n.rawPositions)throw new Error(n.name+" does not implement rawPositions");var u=n.rawPositions(o);return new i(o,u,t,r)},i.isNecessary=function(n,t,r){var e=i.defaults(r),o=n.rawPositions(n.results()),u=function(n){return n.length>0},s=f(o,t,e.breakForBetween);return s.some(u)},i.prototype._verify=function(n,t){return this.strict&&o.nub(t).length!==t.length?"scores must unambiguously decide every position in strict mode":null},i.prototype._safe=o.constant(!0),i.prototype._progress=function(n){if(this.grouped){var t=o.firstBy(function(t){return t.tbSection===n.id.s},this.groupStages),r={s:1,r:n.id.r,m:n.id.m};t.score(r,n.m)}};var m=function(n,t){var r=n["for"]-(n.against||0),e=t["for"]-(t.against||0);return t.pts-n.pts||e-r||n.seed-t.seed},g=function(n,t){return n.pos!==t.pos?n.pos-t.pos:m(n,t)},v=function(n){var t=1;n.forEach(function(n){n.sort(m),n.forEach(function(n){n.pos=t}),t+=n.length})};i.prototype.results=function(){var n=this.oldRes.map(function(n){return o.extend({},n)}),t=o.replicate(this.sectionSize,[]);return this.rawPositions().forEach(function(r){r.forEach(function(r,e){r.forEach(function(r){var i=s.resultEntry(n,r);i.gpos=e+1,t[e].push(i)})})}),this.isDone()&&v(t),n.sort(g)},i.prototype.rawPositions=function(){var n=h.bind(this);return this.posAry.map(function(t,r){var e=n(r+1);return null==e?t:d(t,e)})},i.Id=e,t.exports=i},{groupstage:3,interlude:4,tournament:9}]},{},[])("tiebreaker")});